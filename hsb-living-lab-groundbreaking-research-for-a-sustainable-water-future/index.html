<!DOCTYPE html><html lang="en-gb"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>HSB Living Lab: Groundbreaking Research for a Sustainable Water Future - Lejdfel</title><meta name="description" content="HSB Living Lab: Groundbreaking Research for a Sustainable Water Future In a time where water scarcity is becoming an increasingly pressing challenge, it is crucial&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><script type="text/javascript" async src="https://www.googletagmanager.com/gtag/js?id=G-6J6X49MWGD"></script><script type="text/javascript">window.dataLayer = window.dataLayer || [];
				  function gtag(){dataLayer.push(arguments);}
				  gtag('js', new Date());
				  gtag('config', 'G-6J6X49MWGD' , { 'anonymize_ip': true });</script><link rel="canonical" href="https://lejdfelt.github.io/hsb-living-lab-groundbreaking-research-for-a-sustainable-water-future/"><link rel="alternate" type="application/atom+xml" href="https://lejdfelt.github.io/feed.xml"><link rel="alternate" type="application/json" href="https://lejdfelt.github.io/feed.json"><meta property="og:title" content="HSB Living Lab: Groundbreaking Research for a Sustainable Water Future"><meta property="og:image" content="https://lejdfelt.github.io/media/posts/18/HSBLivingLab.png"><meta property="og:image:width" content="1024"><meta property="og:image:height" content="1024"><meta property="og:site_name" content="Lejdfel"><meta property="og:description" content="HSB Living Lab: Groundbreaking Research for a Sustainable Water Future In a time where water scarcity is becoming an increasingly pressing challenge, it is crucial&hellip;"><meta property="og:url" content="https://lejdfelt.github.io//hsb-living-lab-groundbreaking-research-for-a-sustainable-water-future/"><meta property="og:type" content="article"><link rel="shortcut icon" href="https://lejdfelt.github.io/media/website/favicon-2.ico" type="image/x-icon"><link rel="stylesheet" href="https://lejdfelt.github.io/assets/css/style.css?v=01e6cf86f4b50b25bde1685271aeda61"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://lejdfelt.github.io/hsb-living-lab-groundbreaking-research-for-a-sustainable-water-future/"},"headline":"HSB Living Lab: Groundbreaking Research for a Sustainable Water Future","datePublished":"2025-05-23T14:01","dateModified":"2025-05-23T14:01","image":{"@type":"ImageObject","url":"https://lejdfelt.github.io/media/posts/18/HSBLivingLab.png","height":1024,"width":1024},"description":"HSB Living Lab: Groundbreaking Research for a Sustainable Water Future In a time where water scarcity is becoming an increasingly pressing challenge, it is crucial&hellip;","author":{"@type":"Person","name":"Linus Lejdfelt","url":"https://lejdfelt.github.io/authors/linus-lejdfelt/"},"publisher":{"@type":"Organization","name":"Linus Lejdfelt","logo":{"@type":"ImageObject","url":"https://lejdfelt.github.io/media/website/logo_test4.png","height":540,"width":1168}}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-6J6X49MWGD"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6J6X49MWGD', { 'anonymize_ip': true });</script></head><body class="post-template"><header class="top js-header"><a class="logo" href="https://lejdfelt.github.io/"><img src="https://lejdfelt.github.io/media/website/logo_test4.png" alt="Lejdfel" width="1168" height="540"></a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li class="has-submenu"><span class="is-separator" title="Blogg" aria-haspopup="true">Blog</span><ul class="navbar__submenu level-2" aria-hidden="true"><li><a href="https://lejdfelt.github.io/tags/blogg/" target="_self">Blog posts</a></li><li><a href="https://lejdfelt.github.io/about-the-blogg/" title="About The Blog" target="_self">About The Blog</a></li></ul></li><li class="has-submenu"><span class="is-separator" title="Linus Lejdfelt" aria-haspopup="true">About me</span><ul class="navbar__submenu level-2" aria-hidden="true"><li><a href="https://lejdfelt.github.io/about-me/" target="_self">My Profile</a></li><li><a href="https://lejdfelt.github.io/tags/cv/" title="CV" target="_self">CV</a></li></ul></li></ul></nav></header><main class="post"><article class="content"><div class="hero"><header class="hero__content hero__content--centered"><div class="wrapper"><h1>HSB Living Lab: Groundbreaking Research for a Sustainable Water Future</h1></div></header><figure class="hero__image"><div class="hero__image-wrapper"><img src="https://lejdfelt.github.io/media/posts/18/HSBLivingLab.png" srcset="https://lejdfelt.github.io/media/posts/18/responsive/HSBLivingLab-xs.png 640w, https://lejdfelt.github.io/media/posts/18/responsive/HSBLivingLab-sm.png 768w, https://lejdfelt.github.io/media/posts/18/responsive/HSBLivingLab-md.png 1024w, https://lejdfelt.github.io/media/posts/18/responsive/HSBLivingLab-lg.png 1366w, https://lejdfelt.github.io/media/posts/18/responsive/HSBLivingLab-xl.png 1600w, https://lejdfelt.github.io/media/posts/18/responsive/HSBLivingLab-2xl.png 1920w" sizes="88vw" loading="eager" height="1024" width="1024" alt=""></div></figure></div><div class="entry-wrapper content__entry"><p class="Lexical__paragraph" dir="ltr">HSB Living Lab: Groundbreaking Research for a Sustainable Water Future</p><p class="Lexical__paragraph" dir="ltr">In a time where water scarcity is becoming an increasingly pressing challenge, it is crucial that we find innovative solutions to manage and preserve our water resources. HSB Living Lab in Gothenburg Sweden has been a leading player in this area,</p><p class="Lexical__paragraph" dir="ltr">HSB Living Lab is a building, a residence, and at the same time, a laboratory – and a platform for research and collaboration. It serves as a unique testbed for discovering solutions for sustainable living in the future. Research and development projects get a real opportunity to test their hypotheses in a live environment, with unique opportunities to measure and extract data from the approximately 2000 sensors installed throughout the building and have been running a range of research projects aimed at improving our water usage and ensuring a sustainable future.</p><p class="Lexical__paragraph" dir="ltr">Here is an overview of some of the most significant projects carried out within the framework of HSB Living Lab:</p><ol class="Lexical__ol Lexical__ol--depth-1"><li class="Lexical__listItem" dir="ltr" value="1"><strong><strong class="Lexical__textBold">Collected Experiences of Water</strong></strong><ul class="Lexical__ol Lexical__ol--depth-1"><li class="Lexical__listItem" dir="ltr" value="1">This project gathers insights and experiences regarding water usage and water management, providing a broad understanding of how we can improve our water resources.</li></ul></li><li class="Lexical__listItem" dir="ltr" value="2"><strong><strong class="Lexical__textBold">Everyday Behaviors that Affect the Climate</strong></strong><ul class="Lexical__ul Lexical__ul--depth-2"><li class="Lexical__listItem" dir="ltr" value="1">By studying our daily habits and behaviors, researchers have been able to identify how these impact the climate and water usage.</li></ul></li><li class="Lexical__listItem" dir="ltr" value="3"><strong><strong class="Lexical__textBold">Drop it - How Do We Reduce Water Usage in Households?</strong></strong><ul class="Lexical__ul Lexical__ul--depth-2"><li class="Lexical__listItem" dir="ltr" value="1">This project focuses on finding effective strategies to reduce water consumption at home, which is crucial for preserving our water resources.</li></ul></li><li class="Lexical__listItem" dir="ltr" value="4"><strong><strong class="Lexical__textBold">Lessons from HSB Living Lab on Future Water Scarcity</strong></strong><ul class="Lexical__ul Lexical__ul--depth-2"><li class="Lexical__listItem" dir="ltr" value="1">By learning from HSB Living Lab, we can better prepare for future water scarcity and develop sustainable solutions.</li></ul></li><li class="Lexical__listItem" dir="ltr" value="5"><strong><strong class="Lexical__textBold">Saving and Reusing for Sustainable Water Consumption</strong></strong><ul class="Lexical__ul Lexical__ul--depth-2"><li class="Lexical__listItem" dir="ltr" value="1">Saving and reusing water is central to sustainable water consumption, and this project explores various methods to achieve this.</li></ul></li><li class="Lexical__listItem" dir="ltr" value="6"><strong><strong class="Lexical__textBold">Reduced Water Usage through Increased Control</strong></strong><ul class="Lexical__ul Lexical__ul--depth-2"><li class="Lexical__listItem" dir="ltr" value="1">By increasing control and monitoring of water usage, we can reduce our consumption and preserve water resources.</li></ul></li><li class="Lexical__listItem" dir="ltr" value="7"><strong><strong class="Lexical__textBold">Save Water – But Not the Experience</strong></strong><ul class="Lexical__ul Lexical__ul--depth-2"><li class="Lexical__listItem" dir="ltr" value="1">This project shows how we can save water without compromising the quality of our experiences.</li></ul></li><li class="Lexical__listItem" dir="ltr" value="8"><strong><strong class="Lexical__textBold">Dishwasher Habits Under the Microscope</strong></strong><ul class="Lexical__ul Lexical__ul--depth-2"><li class="Lexical__listItem" dir="ltr" value="1">By studying our habits around using dishwashers, we can find ways to reduce water consumption.</li></ul></li><li class="Lexical__listItem" dir="ltr" value="9"><strong><strong class="Lexical__textBold">Energy-Saving Floor Drains of the Future</strong></strong><ul class="Lexical__ul Lexical__ul--depth-2"><li class="Lexical__listItem" dir="ltr" value="1">Innovative floor drains that save both energy and water are an important step towards a sustainable future.</li></ul></li><li class="Lexical__listItem" dir="ltr" value="10"><strong><strong class="Lexical__textBold">Showers for the Future in HSB Living Lab</strong></strong><ul class="Lexical__ul Lexical__ul--depth-2"><li class="Lexical__listItem" dir="ltr" value="1">Future shower technology can contribute to significant water savings, and this project explores these possibilities.</li></ul></li><li class="Lexical__listItem" dir="ltr" value="11"><strong><strong class="Lexical__textBold">Microplastics from Clothes: Research Paves the Way for New Technology</strong></strong><ul class="Lexical__ul Lexical__ul--depth-2"><li class="Lexical__listItem" dir="ltr" value="1">Research on microplastics from clothes and the development of new technology to reduce this problem is crucial for protecting our water resources.</li></ul></li><li class="Lexical__listItem" dir="ltr" value="12"><strong><strong class="Lexical__textBold">Smart Technology Reuses and Purifies Laundry Water</strong></strong><ul class="Lexical__ul Lexical__ul--depth-2"><li class="Lexical__listItem" dir="ltr" value="1">New technology that makes it possible to reuse and purify water from washing machines is an important step towards sustainable water usage.</li></ul></li><li class="Lexical__listItem" dir="ltr" value="13"><strong><strong class="Lexical__textBold">Connected Sensors for Detecting Water Leaks</strong></strong><ul class="Lexical__ul Lexical__ul--depth-2"><li class="Lexical__listItem" dir="ltr" value="1">The use of sensors to detect and manage water leaks can help reduce water losses.</li></ul></li><li class="Lexical__listItem" dir="ltr" value="14"><strong><strong class="Lexical__textBold">Applied AI on Water Consumption</strong></strong><ul class="Lexical__ul Lexical__ul--depth-2"><li class="Lexical__listItem" dir="ltr" value="1">Artificial intelligence can be used to optimize water consumption and ensure that we use our resources in the best possible way.</li></ul></li><li class="Lexical__listItem" dir="ltr" value="15"><strong><strong class="Lexical__textBold">Where Should the Water Go? Testbeds for Evaluating Stormwater Systems</strong></strong><ul class="Lexical__ul Lexical__ul--depth-2"><li class="Lexical__listItem" dir="ltr" value="1">Testbeds for evaluating different stormwater management systems are crucial for finding the most effective solutions.</li></ul></li><li class="Lexical__listItem" dir="ltr" value="16"><strong><strong class="Lexical__textBold">Innovative Stormwater Management at HSB Living Lab</strong></strong><ul class="Lexical__ul Lexical__ul--depth-2"><li class="Lexical__listItem" dir="ltr" value="1">Innovative solutions for managing stormwater can help reduce flooding and preserve water resources.</li></ul></li><li class="Lexical__listItem" dir="ltr" value="17"><strong><strong class="Lexical__textBold">Flushing with Recycled Water</strong></strong><ul class="Lexical__ul Lexical__ul--depth-2"><li class="Lexical__listItem" dir="ltr" value="1">Techniques for using recycled water for flushing are an important step towards sustainable water usage.</li></ul></li><li class="Lexical__listItem" dir="ltr" value="18"><strong><strong class="Lexical__textBold">Tagged Clothes Provide Answers About Washing Habits</strong></strong><ul class="Lexical__ul Lexical__ul--depth-2"><li class="Lexical__listItem" dir="ltr" value="1">The use of tagged clothes to collect data on washing habits can help us understand and reduce water consumption.</li></ul></li><li class="Lexical__listItem" dir="ltr" value="19"><strong><strong class="Lexical__textBold">Water Purification with Graphene Filters</strong></strong><ul class="Lexical__ul Lexical__ul--depth-2"><li class="Lexical__listItem" dir="ltr" value="1">The use of graphene filters to purify water is a promising technology for ensuring clean water.</li></ul></li><li class="Lexical__listItem" dir="ltr" value="20"><strong><strong class="Lexical__textBold">How Water Can Be Saved Through Simple Measurement</strong></strong><ul class="Lexical__ul Lexical__ul--depth-2"><li class="Lexical__listItem" dir="ltr" value="1">Simple measurement can contribute to significant water savings by giving us better insight into our consumption.</li></ul></li><li class="Lexical__listItem" dir="ltr" value="21"><strong><strong class="Lexical__textBold">THE ONE WHO SAVES THE MOST WATER WINS - Mobile Game to Trigger Water Saving</strong></strong><ul class="Lexical__ul Lexical__ul--depth-2"><li class="Lexical__listItem" dir="ltr" value="1">A mobile game aimed at motivating people to save water can have a big impact on our water consumption.</li></ul></li><li class="Lexical__listItem" dir="ltr" value="22"><strong><strong class="Lexical__textBold">Greywater Recycling</strong></strong><ul class="Lexical__ul Lexical__ul--depth-2"><li class="Lexical__listItem" dir="ltr" value="1">Methods for recycling greywater for various uses are crucial for preserving our water resources.</li></ul></li></ol><p class="Lexical__paragraph" dir="ltr">HSB Living Lab continues to be a leading player in research and development of sustainable water usage solutions. By implementing these innovative projects, we can better prepare for future challenges and ensure that we have enough water for future generations.</p><p class="Lexical__paragraph"> </p></div><footer class="content__footer"><div class="entry-wrapper"><div class="content__actions"><div class="content__share"><button class="btn--icon content__share-button js-content__share-button"><svg width="20" height="20" aria-hidden="true"><use xlink:href="https://lejdfelt.github.io/assets/svg/svg-map.svg#share"></use></svg> <span>Share It</span></button><div class="content__share-popup js-content__share-popup"><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Flejdfelt.github.io%2Fhsb-living-lab-groundbreaking-research-for-a-sustainable-water-future%2F" class="js-share linkedin" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://lejdfelt.github.io/assets/svg/svg-map.svg#linkedin"/></svg> <span>LinkedIn</span> </a><a href="https://api.whatsapp.com/send?text=HSB%20Living%20Lab%3A%20Groundbreaking%20Research%20for%20a%20Sustainable%20Water%20Future https%3A%2F%2Flejdfelt.github.io%2Fhsb-living-lab-groundbreaking-research-for-a-sustainable-water-future%2F" class="js-share whatsapp" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://lejdfelt.github.io/assets/svg/svg-map.svg#whatsapp"/></svg> <span>WhatsApp</span></a></div></div></div></div><nav class="content__nav"><div class="wrapper"><div class="content__nav-inner"><div class="content__nav-prev"><a href="https://lejdfelt.github.io/the-forgotten-fridge-item/" class="content__nav-link" rel="prev"><figure class="content__nav-image"><img src="https://lejdfelt.github.io/media/posts/11/responsive/0242f257-3ac6-45ec-9c63-cbac25baaa5f-xs.png" class="lazyload" loading="lazy" alt="" height="1229" width="1229"></figure><div><span>Previous</span> The Forgotten Fridge Item</div></a></div></div></div></nav></footer></article><div class="content__related related"><div class="wrapper"><h2 class="h4 related__title">You should also read:</h2><article class="feed__item feed__item--centered"><figure class="feed__image related__image"><img src="https://lejdfelt.github.io/media/posts/9/19.gross_green_energy.jpg" srcset="https://lejdfelt.github.io/media/posts/9/responsive/19.gross_green_energy-xs.jpg 640w, https://lejdfelt.github.io/media/posts/9/responsive/19.gross_green_energy-sm.jpg 768w, https://lejdfelt.github.io/media/posts/9/responsive/19.gross_green_energy-md.jpg 1024w" sizes="(min-width: 600px) calc(4.38vw + 143px), 87.86vw" loading="lazy" height="801" width="1201" alt=""></figure><div class="feed__content"><header><div class="feed__meta"><a href="https://lejdfelt.github.io/authors/linus-lejdfelt/" class="feed__author">Linus Lejdfelt</a></div><h3 class="feed__title"><a href="https://lejdfelt.github.io/agroekologi-och-vattenanvaendning-en-hallbar-vaeg-foer-jordbruket/">Agroecology and Water Usage: A Sustainable Path for Agriculture</a></h3></header><p>In a world where water availability is becoming an increasingly urgent issue, the connection between agriculture and water management is more important than ever. Traditional&hellip;</p></div></article></div></div></main><footer class="footer footer--glued"><div class="wrapper"><div class="footer__copyright"><p>©Lejdfelt. All rights reserved. Made with Publii and hosted through GitHub.com</p></div><button onclick="backToTopFunction()" id="backToTop" class="footer__bttop" aria-label="Back to top" title="Back to top"><svg width="20" height="20"><use xlink:href="https://lejdfelt.github.io/assets/svg/svg-map.svg#toparrow"/></svg></button></div></footer><script defer="defer" src="https://lejdfelt.github.io/assets/js/scripts.min.js?v=ffcbea6c02c8178d10092962b235a5b0"></script><script>window.publiiThemeMenuConfig={mobileMenuMode:'sidebar',animationSpeed:300,submenuWidth: 'auto',doubleClickTime:500,mobileMenuExpandableSubmenus:true,relatedContainerForOverlayMenuSelector:'.top'};</script><script>var images = document.querySelectorAll('img[loading]');
        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><div class="pcb" data-behaviour="badge" data-behaviour-link="#cookie-settings" data-revision="1" data-config-ttl="90" data-debug-mode="false"><div role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-title" aria-describedby="pcb-txt" class="pcb__banner"><div class="pcb__inner"><div id="pcb-title" role="heading" aria-level="2" class="pcb__title">This website uses cookies</div><div id="pcb-txt" class="pcb__txt">Select which cookies to opt in to via the checkboxes below. Our website uses cookies to examine site traffic and user activity while on our site, to improve content and handle traffic.</div><div class="pcb__buttons"><button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button></div></div></div><button class="pcb__badge" aria-label="Cookie Policy" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" width="40" height="40" viewBox="0 0 23 23" fill="currentColor"><path d="M21.41 12.71c-.08-.01-.15 0-.22 0h-.03c-.03 0-.05 0-.08.01-.07 0-.13.01-.19.04-.52.21-1.44.19-2.02-.22-.44-.31-.65-.83-.62-1.53a.758.758 0 0 0-.27-.61.73.73 0 0 0-.65-.14c-1.98.51-3.49.23-4.26-.78-.82-1.08-.73-2.89.24-4.49.14-.23.14-.52 0-.75a.756.756 0 0 0-.67-.36c-.64.03-1.11-.1-1.31-.35-.19-.26-.13-.71-.01-1.29.04-.18.06-.38.03-.59-.05-.4-.4-.7-.81-.66C5.1 1.54 1 6.04 1 11.48 1 17.28 5.75 22 11.6 22c5.02 0 9.39-3.54 10.39-8.42.08-.4-.18-.78-.58-.87Zm-9.81 7.82c-5.03 0-9.12-4.06-9.12-9.06 0-4.34 3.05-8 7.25-8.86-.08.7.05 1.33.42 1.81.24.32.66.67 1.38.84-.76 1.86-.65 3.78.36 5.11.61.81 2.03 2 4.95 1.51.18.96.71 1.54 1.18 1.87.62.43 1.38.62 2.1.62.05 0 .09 0 .13-.01-1.23 3.64-4.7 6.18-8.64 6.18ZM13 17c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1Zm5.29-12.3a.99.99 0 0 1-.29-.71c0-.55.45-.99 1-.99a1 1 0 0 1 .71.3c.19.19.29.44.29.71 0 .55-.45.99-1 .99a1 1 0 0 1-.71-.3ZM9 13.5c0 .83-.67 1.5-1.5 1.5S6 14.33 6 13.5 6.67 12 7.5 12s1.5.67 1.5 1.5Zm3.25.81a.744.744 0 0 1-.06-1.05c.28-.32.75-.34 1.05-.06.31.28.33.75.05 1.06-.15.16-.35.25-.56.25-.18 0-.36-.06-.5-.19ZM8.68 7.26c.41.37.44 1 .07 1.41-.2.22-.47.33-.75.33a.96.96 0 0 1-.67-.26c-.41-.37-.44-1-.07-1.41.37-.42 1-.45 1.41-.08Zm11.48 1.88c.18-.19.52-.19.7 0 .05.04.09.1.11.16.03.06.04.12.04.19 0 .13-.05.26-.15.35-.09.1-.22.15-.35.15s-.26-.05-.35-.15a.355.355 0 0 1-.11-.16.433.433 0 0 1-.04-.19c0-.13.05-.26.15-.35Zm-4.93-1.86a.75.75 0 1 1 1.059-1.06.75.75 0 0 1-1.059 1.06Z"/></svg></button></div><script>(function(win) {
    if (!document.querySelector('.pcb')) {
        return;
    }

    var cbConfig = {
        behaviour: document.querySelector('.pcb').getAttribute('data-behaviour'),
        behaviourLink: document.querySelector('.pcb').getAttribute('data-behaviour-link'),
        revision: document.querySelector('.pcb').getAttribute('data-revision'),
        configTTL: parseInt(document.querySelector('.pcb').getAttribute('data-config-ttl'), 10),
        debugMode: document.querySelector('.pcb').getAttribute('data-debug-mode') === 'true',
        initialState: null,
        initialLsState: null,
        previouslyAccepted: []
    };

    var cbUI = {
        wrapper: document.querySelector('.pcb'),
        banner: {
            element: null,
            btnAccept: null,
            btnReject: null,
            btnConfigure: null
        },
        popup: {
            element: null,
            btnClose: null,
            btnSave: null,
            btnAccept: null,
            btnReject: null,
            checkboxes: null,
        },
        overlay: null,
        badge: null,
        blockedScripts: document.querySelectorAll('script[type^="gdpr-blocker/"]'),
        triggerLinks: cbConfig.behaviourLink ? document.querySelectorAll('a[href*="' + cbConfig.behaviourLink + '"]') : null
    };

    function initUI () {
        // setup banner elements
        cbUI.banner.element = cbUI.wrapper.querySelector('.pcb__banner');
        cbUI.banner.btnAccept = cbUI.banner.element.querySelector('.pcb__btn--accept');
        cbUI.banner.btnReject = cbUI.banner.element.querySelector('.pcb__btn--reject');
        cbUI.banner.btnConfigure = cbUI.banner.element.querySelector('.pcb__btn--configure');

        // setup popup elements
        if (cbUI.wrapper.querySelector('.pcb__popup')) {
            cbUI.popup.element = cbUI.wrapper.querySelector('.pcb__popup');
            cbUI.popup.btnClose = cbUI.wrapper.querySelector('.pcb__popup__close');
            cbUI.popup.btnSave = cbUI.popup.element.querySelector('.pcb__btn--save');
            cbUI.popup.btnAccept = cbUI.popup.element.querySelector('.pcb__btn--accept');
            cbUI.popup.btnReject = cbUI.popup.element.querySelector('.pcb__btn--reject');
            cbUI.popup.checkboxes = cbUI.popup.element.querySelector('input[type="checkbox"]');
            // setup overlay
            cbUI.overlay = cbUI.wrapper.querySelector('.pcb__overlay');
        }

        cbUI.badge = cbUI.wrapper.querySelector('.pcb__badge');

        if (cbConfig.behaviour.indexOf('link') > -1) {
            for (var i = 0; i < cbUI.triggerLinks.length; i++) {
                cbUI.triggerLinks[i].addEventListener('click', function(e) {
                    e.preventDefault();
                    showBannerOrPopup();
                });
            }
        }
    }

    function initState () {
        var lsKeyName = getConfigName();
        var currentConfig = localStorage.getItem(lsKeyName);
        var configIsFresh = checkIfConfigIsFresh();

        if (!configIsFresh || currentConfig === null) {
            if (cbConfig.debugMode) {
                console.log('🍪 Config not found, or configuration expired');
            }

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                    'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                    'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                    'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                    'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                    'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                    'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                });  
                
                if (cbConfig.debugMode) {
                    console.log('🍪 GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                        'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                        'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                        'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                        'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                        'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                        'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                    }));
                }
            }

            showBanner();
        } else if (typeof currentConfig === 'string') {
            if (cbConfig.debugMode) {
                console.log('🍪 Config founded');
            }

            cbConfig.initialLsState = currentConfig.split(',');

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                    'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                    'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                    'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                    'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                    'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                    'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                });
                
                if (cbConfig.debugMode) {
                    console.log('🍪 GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                        'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                        'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                        'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                        'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                        'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                        'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                    }));
                }
            }

            showBadge();

            if (cbUI.popup.element) {
                var allowedGroups = currentConfig.split(',');
                var checkedCheckboxes = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');

                for (var j = 0; j < checkedCheckboxes.length; j++) {
                    var name = checkedCheckboxes[j].getAttribute('data-group-name');

                    if (name && name !== '-' && allowedGroups.indexOf(name) === -1) {
                        checkedCheckboxes[j].checked = false;
                    }
                }

                for (var i = 0; i < allowedGroups.length; i++) {
                    var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + allowedGroups[i] + '"]');

                    if (checkbox) {
                        checkbox.checked = true;
                    }

                    allowCookieGroup(allowedGroups[i]);
                }
            }
        }

        setTimeout(function () {
            cbConfig.initialState = getInitialStateOfConsents();
        }, 0);
    }

    function checkIfConfigIsFresh () {
        var lastConfigSave = localStorage.getItem('publii-gdpr-cookies-config-save-date');

        if (lastConfigSave === null) {
            return false;
        }

        lastConfigSave = parseInt(lastConfigSave, 10);

        if (lastConfigSave === 0) {
            return true;
        }

        if (+new Date() - lastConfigSave < cbConfig.configTTL * 24 * 60 * 60 * 1000) {
            return true;
        }

        return false;
    }

    function getDefaultConsentState (currentConfig, consentGroup) {
        let configGroups = currentConfig.split(',');

        for (let i = 0; i < configGroups.length; i++) {
            let groupName = configGroups[i];
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === groupName);

            if (group && group[consentGroup]) {
                return 'granted';
            }
        }  
        
        if (window.publiiCBGCM.defaultState[consentGroup]) {
            return 'granted'; 
        }
        
        return 'denied';
    }

    function initBannerEvents () {
        cbUI.banner.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('banner');
            showBadge();
        }, false);

        if (cbUI.banner.btnReject) {
            cbUI.banner.btnReject.addEventListener('click', function (e) {
                e.preventDefault();
                rejectAllCookies();
                showBadge();
            }, false);
        }

        if (cbUI.banner.btnConfigure) {
            cbUI.banner.btnConfigure.addEventListener('click', function (e) {
                e.preventDefault();
                hideBanner();
                showAdvancedPopup();
                showBadge();
            }, false);
        }
    }

    function initPopupEvents () {
        if (!cbUI.popup.element) {
            return;
        }

        cbUI.overlay.addEventListener('click', function (e) {
            hideAdvancedPopup();
        }, false);

        cbUI.popup.element.addEventListener('click', function (e) {
            e.stopPropagation();
        }, false);

        cbUI.popup.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('popup');
        }, false);

        cbUI.popup.btnReject.addEventListener('click', function (e) {
            e.preventDefault();
            rejectAllCookies();
        }, false);

        cbUI.popup.btnSave.addEventListener('click', function (e) {
            e.preventDefault();
            saveConfiguration();
        }, false);

        cbUI.popup.btnClose.addEventListener('click', function (e) {
            e.preventDefault();
            hideAdvancedPopup();
        }, false);
    }

    function initBadgeEvents () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.addEventListener('click', function (e) {
            showBannerOrPopup();
        }, false);
    }

    initUI();
    initState();
    initBannerEvents();
    initPopupEvents();
    initBadgeEvents();

    /**
     * API
     */
    function addScript (src, inline) {
        var newScript = document.createElement('script');

        if (src) {
            newScript.setAttribute('src', src);
        }

        if (inline) {
            newScript.text = inline;
        }

        document.body.appendChild(newScript);
    }

    function allowCookieGroup (allowedGroup) {
        var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + allowedGroup + '"]');
        cbConfig.previouslyAccepted.push(allowedGroup);
    
        for (var j = 0; j < scripts.length; j++) {
            addScript(scripts[j].src, scripts[j].text);
        }

        var groupEvent = new Event('publii-cookie-banner-unblock-' + allowedGroup);
        document.body.dispatchEvent(groupEvent);
        unlockEmbeds(allowedGroup);

        if (cbConfig.debugMode) {
            console.log('🍪 Allowed group: ' + allowedGroup);
        }

        if (window.publiiCBGCM && cbConfig.initialLsState.indexOf(allowedGroup) === -1) {
            let consentResult = {};
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === allowedGroup);

            if (group) {
                let foundSomeConsents = false;

                Object.keys(group).forEach(key => {
                    if (key !== 'cookieGroup' && group[key] === true) {
                        consentResult[key] = 'granted';
                        foundSomeConsents = true;
                    }
                });

                if (foundSomeConsents) {
                    gtag('consent', 'update', consentResult);   

                    if (cbConfig.debugMode) {
                        console.log('🍪 GCMv2 UPDATE: ' + JSON.stringify(consentResult));
                    }
                }
            }
        }
    }

    function showBannerOrPopup () {
        if (cbUI.popup.element) {
            showAdvancedPopup();
        } else {
            showBanner();
        }
    }

    function showAdvancedPopup () {
        cbUI.popup.element.classList.add('is-visible');
        cbUI.overlay.classList.add('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'false');
        cbUI.overlay.setAttribute('aria-hidden', 'false');
    }

    function hideAdvancedPopup () {
        cbUI.popup.element.classList.remove('is-visible');
        cbUI.overlay.classList.remove('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'true');
        cbUI.overlay.setAttribute('aria-hidden', 'true');
    }

    function showBanner () {
        cbUI.banner.element.classList.add('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'false');
    }

    function hideBanner () {
        cbUI.banner.element.classList.remove('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'true');
    }

    function showBadge () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.classList.add('is-visible');
        cbUI.badge.setAttribute('aria-hidden', 'false');
    }

    function getConfigName () {
        var lsKeyName = 'publii-gdpr-allowed-cookies';

        if (cbConfig.revision) {
            lsKeyName = lsKeyName + '-v' + parseInt(cbConfig.revision, 10);
        }

        return lsKeyName;
    }

    function storeConfiguration (allowedGroups) {
        var lsKeyName = getConfigName();
        var dataToStore = allowedGroups.join(',');
        localStorage.setItem(lsKeyName, dataToStore);

        if (cbConfig.configTTL === 0) {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', 0);

            if (cbConfig.debugMode) {
                console.log('🍪 Store never expiring configuration');
            }
        } else {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', +new Date());
        }
    }

    function getInitialStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Initial state: ' + groups.join(', '));
        }

        return groups;
    }

    function getCurrentStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 State to save: ' + groups.join(', '));
        }

        return groups;
    }

    function getAllGroups () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        return groups;
    }

    function acceptAllCookies (source) {
        var groupsToAccept = getAllGroups();
        storeConfiguration(groupsToAccept);

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        if (cbUI.popup.element) {
            var checkboxesToCheck = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');

            for (var j = 0; j < checkboxesToCheck.length; j++) {
                checkboxesToCheck[j].checked = true;
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Accept all cookies: ', groupsToAccept.join(', '));
        }

        if (source === 'popup') {
            hideAdvancedPopup();
        } else if (source === 'banner') {
            hideBanner();
        }
    }

    function rejectAllCookies () {
        if (cbConfig.debugMode) {
            console.log('🍪 Reject all cookies');
        }

        storeConfiguration([]);
        setTimeout(function () {
            window.location.reload();
        }, 100);
    }

    function saveConfiguration () {
        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }

        if (reloadIsNeeded(groupsToAccept)) {
            setTimeout(function () {
                window.location.reload();
            }, 100);
            return;
        }

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        hideAdvancedPopup();
    }

    function reloadIsNeeded (groupsToAccept) {
        // check if user rejected consent for initial groups
        var initialGroups = cbConfig.initialState;
        var previouslyAcceptedGroups = cbConfig.previouslyAccepted;
        var groupsToCheck = initialGroups.concat(previouslyAcceptedGroups);

        for (var i = 0; i < groupsToCheck.length; i++) {
            var groupToCheck = groupsToCheck[i];

            if (groupToCheck !== '' && groupsToAccept.indexOf(groupToCheck) === -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Reload is needed due lack of: ', groupToCheck);
                }

                return true;
            }
        }

        return false;
    }

    function unlockEmbeds (cookieGroup) {
        var iframesToUnlock = document.querySelectorAll('.pec-wrapper[data-consent-group-id="' + cookieGroup + '"]');

        for (var i = 0; i < iframesToUnlock.length; i++) {
            var iframeWrapper = iframesToUnlock[i];
            iframeWrapper.querySelector('.pec-overlay').classList.remove('is-active');
            iframeWrapper.querySelector('.pec-overlay').setAttribute('aria-hidden', 'true');
            var iframe = iframeWrapper.querySelector('iframe');
            iframe.setAttribute('src', iframe.getAttribute('data-consent-src'));
        }
    }

    win.publiiEmbedConsentGiven = function (cookieGroup) {
        // it will unlock embeds
        allowCookieGroup(cookieGroup);

        var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + cookieGroup + '"]');

        if (checkbox) {
            checkbox.checked = true;
        }

        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }
    }
})(window);</script></body></html>